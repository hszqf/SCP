# 游戏配置说明

## 1. 配置文件位置与加载
- 主配置文件（通过excel生成）：Assets/StreamingAssets/game_data.json
- 运行时入口：DataRegistry 加载并建立索引；WebGL 使用异步加载。
- 表结构：game_data.json -> tables -> 每个表包含 idField、columns、rows。

## 2. 游戏流程（宏观）
### 2.1 初始化
1. 读取 Balance 初始化全局数值（资金、世界恐慌、最小值 Clamp）。
2. 读取场景 City 组件生成节点；CityId 会在启动时自动生成/修复并作为 nodeId。
3. 生成初始异常（AnomaliesGen day=1）。
4. 生成启动新闻（NewsGenerator）。

### 2.2 日结算（StepDay）
按天推进，核心步骤顺序如下：
1. 异常生成：按 AnomaliesGen 表在指定天数生成异常。
2. 任务推进：遍历所有节点的 Active 任务，
   - 先检查事件阻塞（blockPolicy），被阻塞则不推进。
   - 计算队伍与异常需求的匹配度，得到每日进度增量。
   - Manage 任务永不自动完成，仅用于持续产出与每日影响。
   - Investigate/Contain 达到 baseDays 视为完成。
3. 管理系统：Manage 任务按天产生负熵并对干员造成影响。
4. 干员恢复：空闲干员每日恢复一定 HP/SAN。
5. 忽略事件惩罚：对未处理事件执行 ignoreEffect（可按天或只一次）。
6. 事件自动关闭：超过 autoResolveAfterDays 自动移除。
7. RandomDaily 事件生成：基于条件匹配 + 概率 + 权重筛选。
8. RandomDaily 新闻生成：基于条件匹配 + 概率 + 权重筛选。
9. 经济与恐慌结算：
   - 收入：人口 * PopToMoneyRate
   - 支出：干员工资 + 已收容异常维护费
   - 世界恐慌：未收容异常按 worldPanicPerDayUncontained 增加
   - 达到 WorldPanicFailThreshold 则失败

## 3. 系统逻辑要点
### 3.1 任务系统
- 任务类型：Investigate / Contain / Manage
- 一个节点可并行多个任务。
- 任务进度：基于队伍属性与异常需求的匹配度；Manage 不完成，只维持 0~0.99。
- Investigate 完成：发现异常并加入 KnownAnomalyDefIds。
- Contain 完成：获得资金奖励并降低世界恐慌，异常加入 ManagedAnomalies。

### 3.2 事件系统
- 事件实例挂在节点 PendingEvents。
- 事件选项触发 EffectOps。
- 事件阻塞策略 blockPolicy 可阻塞来源任务或全节点任务。
- ignoreEffectId 处理“未处理事件”的惩罚，可按 IgnoreApplyMode 控制。

### 3.3 新闻系统
- 新闻由 RandomDaily 生成，规则类似事件，但仅写入 NewsLog。

### 3.4 经济/恐慌
- Money、WorldPanic 均可被 EffectOps 影响，且受 Clamp 最小值限制。

### 3.5 管理/负熵
- Manage 任务按天产出 NegEntropy（来自异常配置）。
- Manage 任务会持续对参与干员产生 SAN/HP 影响。

## 4. 表格配置字段含义
下面所有表均在 game_data.json -> tables 中配置。

### 4.1 Meta
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| schemaVersion | string | 数据结构版本 | 供校验与兼容使用 |
| dataVersion | string | 数据内容版本 | 便于版本管理 |

### 4.2 Balance（全局数值）
- 取值规则：
  - p1 为 int[]，p2 为 float[]，p3 为 string[]
  - GetBalanceInt/Float/String 只取数组第 1 个值

| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| key | string | 键名 | 唯一标识 |
| p1 | int[] | 整数参数 | 可留空 |
| p2 | float[] | 浮点参数 | 可留空 |
| p3 | string[] | 字符串参数 | 可留空 |

常用 key（与代码一致）：
- StartMoney：初始资金（int）
- StartWorldPanic：初始世界恐慌（float）
- PopToMoneyRate：人口转收入比率（float）
- WagePerAgentPerDay：干员日工资（int）
- ContainedAnomalyMaintenanceDefault：收容异常默认维护费（int）
- WorldPanicFailThreshold：失败阈值（float）
- ContainReliefFixed：收容成功降低恐慌（int）
- ClampWorldPanicMin：世界恐慌最小值（float）
- ClampMoneyMin：资金最小值（int）
- LocalPanicHighThreshold：节点恐慌高阈值（int）
- RandomEventBaseProb：事件基础概率（float）
- DefaultAutoResolveAfterDays：事件默认自动关闭天数（int）
- DefaultIgnoreApplyMode：默认忽略惩罚模式（string）

### 4.3 Anomalies
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| anomalyId | string | 异常 ID | 建议 AN_001 结构 |
| name | string | 异常名称 | UI 显示 |
| class | string | 异常等级 | Safe/Euclid/Keter 等 |
| worldPanicPerDayUncontained | float | 未收容每日世界恐慌增加 | 结算用 |
| baseDays | int | 调查/收容基础天数 | 任务进度上限 |
| maintenanceCostPerDay | int | 收容后维护费 | 日结算支出 |
| actPeopleKill | int | 行动伤亡基数 | 行动影响使用 |
| invReq | int[4] | 调查需求 | 对应 Perception/Operation/Resistance/Power |
| conReq | int[4] | 收容需求 | 同上 |
| manReq | int[4] | 管理需求 | 同上 |
| invhpDmg | int | 调查 HP 伤害 | 行动影响 |
| invsanDmg | int | 调查 SAN 伤害 | 行动影响 |
| conhpDmg | int | 收容 HP 伤害 | 行动影响 |
| consanDmg | int | 收容 SAN 伤害 | 行动影响 |
| manhpDmg | int | 管理 HP 伤害 | 行动影响 |
| mansanDmg | int | 管理 SAN 伤害 | 行动影响 |
| invExp | int | 调查完成经验 | 分摊给参与干员 |
| conExp | int | 收容完成经验 | 分摊给参与干员 |
| manExpPerDay | int | 管理每日经验 | 分摊给参与干员 |
| manNegentropy PerDay | int | 管理每日负熵 | 注意字段名含空格 |

备注：baseThreat 在代码中被读取，但当前表未提供时会使用默认值。

### 4.5 AnomaliesGen
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| day | int | 指定天数 | 触发生成 |
| AnomaliesGenNum | int | 当天生成数量 | 随机分配到节点 |

### 4.6 TaskDefs
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| taskDefId | string | 任务定义 ID | 可用于 UI/统计 |
| taskType | string | 任务类型 | Investigate/Contain/Manage |
| name | string | 任务名称 | UI 显示 |
| agentSlotsMin | int | 最少干员数 | 约束派遣 |
| agentSlotsMax | int | 最多干员数 | 约束派遣 |

### 4.7 Events
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| eventDefId | string | 事件 ID | 建议 EV_001… |
| source | string | 事件来源 | 常用 RandomDaily |
| weight | int | 权重 | 匹配后按权重抽取 |
| title | string | 标题 | UI 显示 |
| desc | string | 描述 | UI 显示 |
| blockPolicy | string | 阻塞策略 | None / BlockOriginTask / BlockAllTasksOnNode |
| defaultAffects | string[] | 默认影响范围 | 作用于 EffectOps 过滤 |
| autoResolveAfterDays | int | 自动关闭天数 | >0 生效 |
| ignoreApplyMode | string | 忽略惩罚模式 | ApplyOnceThenRemove / ApplyDailyKeep / NeverAuto |
| ignoreEffectId | string | 忽略惩罚效果 | 对应 Effects/EffectOps |
| requiresNodeId | string | 节点条件 | ANY 或指定节点 ID |
| requiresAnomalyId | string | 异常条件 | ANY 或指定异常 ID |
| requiresTaskType | string | 任务类型条件 | ANY / Investigate / Contain / Manage |
| p | float | 触发概率 | 0~1，用于最终触发 |
| minDay | int | 最小天数 | 未满足不触发 |
| maxDay | int | 最大天数 | 0 表示不限制 |
| CD | int | 冷却天数 | 同一事件的再次触发间隔 |
| limitNum | int | 触发次数上限 | 超过则不再触发 |

### 4.8 EventOptions
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| key | string | 行标识 | 当前表的 idField |
| eventDefId | string | 所属事件 | 关联 Events.eventDefId |
| optionId | string | 选项 ID | 事件内唯一 |
| text | string | 选项文本 | UI 显示 |
| resultText | string | 结果文本 | 为空则自动生成摘要 |
| affects | string[] | 影响范围 | 覆盖 Events.defaultAffects |
| effectId | string | 效果 ID | 对应 Effects/EffectOps |

### 4.9 Effects
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| key | string | 行标识 | 当前表的 idField |
| effectId | string | 效果 ID | 供 EventOptions 引用 |
| comment | string | 备注 | 仅说明用途 |

### 4.10 EffectOps
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| key | string | 行标识 | 当前表的 idField |
| effectId | string | 效果 ID | 关联 Effects.effectId |
| scope | string | 作用域 | Node / Global / OriginTask / TaskType:Investigate 等 |
| statKey | string | 影响数值 | 见下方列表 |
| op | string | 运算类型 | Add / Mul / Set / ClampAdd |
| value | float | 数值 | 运算参数 |
| min | float? | 最小限制 | 可为空 |
| max | float? | 最大限制 | 可为空 |
| comment | string | 备注 | 仅说明用途 |

statKey 允许值：
- Node：LocalPanic、Population
- OriginTask/TaskType：TaskProgressDelta（0~1）
- Global：WorldPanic、Panic、Money、NegEntropy

### 4.11 NewsDefs
| 字段 | 类型 | 含义 | 备注 |
| --- | --- | --- | --- |
| newsDefId | string | 新闻 ID | 建议 NW_001… |
| source | string | 来源 | 常用 RandomDaily |
| requiresNodeId | string | 节点条件 | ANY 或指定节点 ID |
| requiresAnomalyId | string | 异常条件 | ANY 或指定异常 ID |
| weight | int | 权重 | 匹配后按权重抽取 |
| p | float | 触发概率 | 0~1，用于最终触发 |
| minDay | int | 最小天数 | 未满足不触发 |
| maxDay | int | 最大天数 | 0 表示不限制 |
| CD | int | 冷却天数 | 同一新闻再次触发间隔 |
| limitNum | int | 触发次数上限 | 超过则不再触发 |
| title | string | 标题 | UI 显示 |
| desc | string | 描述 | UI 显示 |

## 5. AffectScope 与 EffectOp 取值说明
### 5.1 AffectScope（事件影响范围）
- Node：影响事件所在节点
- Global：影响全局状态
- OriginTask：影响触发事件的任务
- TaskType:Investigate / TaskType:Contain / TaskType:Manage：影响所有指定类型任务

### 5.2 EffectOp 运算
- Add：current + value
- Mul：current * value
- Set：current = value
- ClampAdd：current + value 并按 min/max 夹取

## 6. 内容扩充配置流程（推荐）
1. 新增异常：在 Anomalies 表新增行，保证 anomalyId 唯一。
2. 设定生成规则：在 AnomaliesGen 中指定天数与生成数量。
3. 调整任务参数：在 TaskDefs 中配置 agentSlotsMin/Max 与显示名。
4. 新增事件：在 Events 中配置触发条件与阻塞策略。
5. 新增事件选项：在 EventOptions 中配置选项文本与 effectId。
6. 新增效果：在 Effects 中创建 effectId，并在 EffectOps 中定义具体数值变化。
7. 新增新闻：在 NewsDefs 中配置权重与触发条件。
8. 平衡数值：在 Balance 中调整经济、恐慌、默认规则等参数。

## 7. 常见注意事项
- 字段大小写与拼写需与表头完全一致；当前表中存在 manNegentropy PerDay 的空格写法。
- Events/NewsDefs 的 requires* 使用 ANY 表示不过滤。
- effectId、eventDefId 等需保证跨表一致引用。
- 缺失字段会触发警告并使用默认值，可能导致逻辑偏差。
