{
    "batch_id": "ms0_event_baseline_snapshot",
    "results": [
        {
            "id": 1,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "Scene opened."
        },
        {
            "id": 10,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "EventPanel (Inactive) [RectTransform,CanvasRenderer,Image,EventPanel]\r\n--Title [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n--Desc [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n--resultText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n--Options [RectTransform,VerticalLayoutGroup]\r\n"
        },
        {
            "id": 11,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "Panels",
            "data": "m_Script (ObjectReference): UIPanelRoot\ndim (ObjectReference): Dim\nnodePanel (ObjectReference): NodePanel\nnodeTitle (ObjectReference): TItle\nnodeStatus (ObjectReference): Status\nprogressText (ObjectReference): progressText\ninvestigateButton (ObjectReference): null\ncontainButton (ObjectReference): null\ncloseNodeButton (ObjectReference): null\neventPanel (ObjectReference): EventPanel\nnewsPanel (ObjectReference): NewsPanel\ncloseNewsButton (ObjectReference): null\nconfirmDialog (ObjectReference): null\nwithdrawButton (ObjectReference): null\nwithdrawButtonLabel (ObjectReference): null\nuseAgentPicker (Boolean): True\nfallbackAgentIds (Generic): Unk\npickerSize (Vector2): Unk"
        },
        {
            "id": 20,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing Core;\nusing TMPro;\nusing UnityEngine;\nusing UnityEngine.UI;\n\npublic class UIPanelRoot : MonoBehaviour\n{\n    public static UIPanelRoot I { get; private set; }\n\n    [Header(\"Modal\")]\n    [SerializeField] private GameObject dim;\n\n    [Header(\"Node Panel (drag NodePanel root)\")]\n    [SerializeField] private GameObject nodePanel;     // 拖 NodePanel（父物体）\n    [SerializeField] private TMP_Text nodeTitle;        // 拖 NodePanel/Panel/TItle\n    [SerializeField] private TMP_Text nodeStatus;       // 拖 NodePanel/Panel/Status\n    [SerializeField] private TMP_Text progressText;     // 拖 NodePanel/Panel/progressText\n\n    [Header(\"Node Panel Buttons (bind in code; Inspector OnClick should be empty)\")]\n    [SerializeField] private Button investigateButton;  // 拖 NodePanel/Panel/InvestigateBT\n    [SerializeField] private Button containButton;      // 拖 NodePanel/Panel/ContainBT\n    [SerializeField] private Button closeNodeButton;    // 拖 NodePanel/Panel/CloseBT\n\n    [Header(\"Event Panel\")]\n    [SerializeField] private EventPanel eventPanel;     // 拖场景里的 EventPanel 实例\n\n    [Header(\"News Panel\")]\n    [SerializeField] private NewsPanel newsPanel;       // 拖场景里的 NewsPanel 实例\n    [Header(\"News Panel Buttons (bind in code)\")]\n    [SerializeField] private Button closeNewsButton; // 拖 NewsPanel 里的关闭按钮（可选，没拖也会自动找）\n\n\n    [Header(\"Confirm/Withdraw (Milestone 1; optional in Milestone 0)\")]\n    [SerializeField] private ConfirmDialog confirmDialog;\n    [SerializeField] private Button withdrawButton;\n    [SerializeField] private TMP_Text withdrawButtonLabel;\n\n    // ===================== Agent Picker (existing approach) =====================\n    [Header(\"Dispatch UI (Agent Picker)\")]\n    [SerializeField] private bool useAgentPicker = true;\n    [SerializeField] private string[] fallbackAgentIds = new[] { \"A1\", \"A2\", \"A3\" };\n    [SerializeField] private Vector2 pickerSize = new Vector2(900, 600);\n\n    enum AssignMode { Investigate, Contain }\n\n    private GameObject _agentPickerRoot;\n    private TMP_Text _pickerTitle;\n    private ScrollRect _pickerScroll;\n    private RectTransform _pickerContent;\n    private AssignMode _pickerMode;\n\n    // ===========================================================================\n\n    private string _currentNodeId;\n\n    private void Awake()\n    {\n        I = this;\n\n        if (!ValidateBindings())\n        {\n            enabled = false;\n            return;\n        }\n\n        AutoWireNodePanelButtonsIfMissing();\n        BindNodePanelButtonsInCode();\n        AutoWireNewsPanelButtonsIfMissing();\n        BindNewsPanelButtonsInCode();\n\n\n        ResetUI();\n        EnsureAgentPickerCreated();\n    }\n\n    private void OnEnable()\n    {\n        if (GameController.I != null)\n            GameController.I.OnStateChanged += OnGameStateChanged;\n\n        OnGameStateChanged();\n    }\n\n    private void OnDisable()\n    {\n        if (GameController.I != null)\n            GameController.I.OnStateChanged -= OnGameStateChanged;\n    }\n\n    bool ValidateBindings()\n    {\n        bool ok = true;\n\n        void Req(object o, string name)\n        {\n            if (o == null)\n            {\n                Debug.LogError($\"[UIPanelRoot] Missing binding: {name}\", this);\n                ok = false;\n            }\n        }\n\n        Req(dim, nameof(dim));\n        Req(nodePanel, nameof(nodePanel));\n        Req(nodeTitle, nameof(nodeTitle));\n        Req(nodeStatus, nameof(nodeStatus));\n        Req(progressText, nameof(progressText));\n        Req(eventPanel, nameof(eventPanel));\n        Req(newsPanel, nameof(newsPanel));\n\n        // Milestone 0: confirm/withdraw 可为空（先不硬要求）\n        if (!confirmDialog) Debug.LogWarning(\"[UIPanelRoot] confirmDialog not bound (OK in Milestone 0)\", this);\n        if (!withdrawButton) Debug.LogWarning(\"[UIPanelRoot] withdrawButton not bound (OK in Milestone 0)\", this);\n\n        return ok;\n    }\n\n    void AutoWireNodePanelButtonsIfMissing()\n    {\n        // 场景层级：NodePanel/Panel/InvestigateBT, ContainBT, CloseBT :contentReference[oaicite:2]{index=2}\n        if (!nodePanel) return;\n\n        var panel = nodePanel.transform.Find(\"Panel\");\n        if (!panel) return;\n\n        if (!investigateButton)\n        {\n            var t = panel.Find(\"InvestigateBT\");\n            if (t) investigateButton = t.GetComponent<Button>();\n        }\n\n        if (!containButton)\n        {\n            var t = panel.Find(\"ContainBT\");\n            if (t) containButton = t.GetComponent<Button>();\n        }\n\n        if (!closeNodeButton)\n        {\n            var t = panel.Find(\"CloseBT\");\n            if (t) closeNodeButton = t.GetComponent<Button>();\n        }\n    }\n\n    void BindNodePanelButtonsInCode()\n    {\n        if (investigateButton)\n        {\n            investigateButton.onClick.RemoveAllListeners();\n            investigateButton.onClick.AddListener(OnInvestigate);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] investigateButton not bound (expected NodePanel/Panel/InvestigateBT)\", this);\n\n        if (containButton)\n        {\n            containButton.onClick.RemoveAllListeners();\n            containButton.onClick.AddListener(OnContain);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] containButton not bound (expected NodePanel/Panel/ContainBT)\", this);\n\n        if (closeNodeButton)\n        {\n            closeNodeButton.onClick.RemoveAllListeners();\n            closeNodeButton.onClick.AddListener(CloseNode);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] closeNodeButton not bound (expected NodePanel/Panel/CloseBT)\", this);\n    }\n    void AutoWireNewsPanelButtonsIfMissing()\n    {\n        if (closeNewsButton != null) return;\n        if (!newsPanel) return;\n\n        // 尝试用“名字包含 close / x”的规则自动找一个按钮作为关闭\n        var buttons = newsPanel.GetComponentsInChildren<Button>(true);\n        foreach (var b in buttons)\n        {\n            if (!b) continue;\n            var n = b.name;\n            if (n.IndexOf(\"close\", StringComparison.OrdinalIgnoreCase) >= 0 ||\n                n.IndexOf(\"x\", StringComparison.OrdinalIgnoreCase) == 0 ||   // \"X\"\n                string.Equals(n, \"CloseBT\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(n, \"Close\", StringComparison.OrdinalIgnoreCase))\n            {\n                closeNewsButton = b;\n                break;\n            }\n        }\n    }\n\n    void BindNewsPanelButtonsInCode()\n    {\n        if (!closeNewsButton)\n        {\n            Debug.LogWarning(\"[UIPanelRoot] closeNewsButton not bound (NewsPanel close will not work). Drag it in Inspector or rename it to CloseBT.\", this);\n            return;\n        }\n\n        closeNewsButton.onClick.RemoveAllListeners();\n        closeNewsButton.onClick.AddListener(CloseNews);\n    }\n\n    void OnGameStateChanged()\n    {\n        // 如果节点面板开着，刷新它\n        if (!string.IsNullOrEmpty(_currentNodeId) && nodePanel && nodePanel.activeSelf)\n            RefreshNodePanel();\n\n        // 统一“弹事件”的入口：避免 HUD 多次 Refresh 导致重复开\n        TryAutoOpenEvent();\n    }\n\n    void TryAutoOpenEvent()\n    {\n        if (GameController.I == null) return;\n\n        // 有别的 modal 在显示时不自动弹事件（避免抢焦点）\n        if (IsAnyModalOpen())\n            return;\n\n        var list = GameController.I.State.PendingEvents;\n        if (list == null || list.Count == 0) return;\n\n        OpenEventIfAny();\n    }\n\n    bool IsAnyModalOpen()\n    {\n        if (confirmDialog && confirmDialog.gameObject.activeSelf) return true;\n        if (eventPanel && eventPanel.gameObject.activeSelf) return true;\n        if (newsPanel && newsPanel.gameObject.activeSelf) return true;\n        if (nodePanel && nodePanel.activeSelf) return true;\n        return false;\n    }\n\n    private void ResetUI()\n    {\n        if (eventPanel) eventPanel.gameObject.SetActive(false);\n        if (newsPanel) newsPanel.Hide();\n        if (nodePanel) nodePanel.SetActive(false);\n        if (dim) dim.SetActive(false);\n\n        _currentNodeId = null;\n        HideAgentPicker();\n    }\n\n    // ========= 核心：管理 Dim 与顶层面板的 sibling 顺序 =========\n    void SetModalTop(RectTransform topPanel)\n    {\n        if (!dim) return;\n\n        if (topPanel == null || !topPanel.gameObject.activeSelf)\n        {\n            dim.SetActive(false);\n            return;\n        }\n\n        dim.SetActive(true);\n\n        // topPanel 永远最上层\n        topPanel.SetAsLastSibling();\n\n        // dim 永远在 topPanel 下一层，避免盖住 topPanel\n        int topIndex = topPanel.GetSiblingIndex();\n        dim.transform.SetSiblingIndex(Mathf.Max(0, topIndex - 1));\n    }\n\n    RectTransform GetTopModal()\n    {\n        if (confirmDialog && confirmDialog.gameObject.activeSelf) return (RectTransform)confirmDialog.transform;\n        if (eventPanel && eventPanel.gameObject.activeSelf) return (RectTransform)eventPanel.transform;\n        if (newsPanel && newsPanel.gameObject.activeSelf) return (RectTransform)newsPanel.transform;\n        if (nodePanel && nodePanel.activeSelf) return (RectTransform)nodePanel.transform;\n        return null;\n    }\n\n    // ========= Node Panel =========\n    public void OpenNode(string nodeId)\n    {\n        _currentNodeId = nodeId;\n\n        if (nodePanel) nodePanel.SetActive(true);\n        SetModalTop((RectTransform)nodePanel.transform);\n\n        RefreshNodePanel();\n    }\n\n    public void RefreshNodePanel()\n    {\n        if (string.IsNullOrEmpty(_currentNodeId)) return;\n        if (GameController.I == null) return;\n\n        NodeState n = GameController.I.GetNode(_currentNodeId);\n        if (n == null) return;\n\n        if (nodeTitle) nodeTitle.text = n.Name;\n\n        float p =\n            n.Status == NodeStatus.Investigating ? n.InvestigateProgress :\n            n.Status == NodeStatus.Containing ? n.ContainProgress :\n            0f;\n\n        if (nodeStatus)\n            nodeStatus.text = $\"{n.Status} | Anomaly:{n.HasAnomaly} L{n.AnomalyLevel}\";\n\n        if (progressText)\n            progressText.text =\n                $\"Progress: {Mathf.RoundToInt(p * 100)}%  |  Agent: {(string.IsNullOrEmpty(n.AssignedAgentId) ? \"-\" : n.AssignedAgentId)}\";\n    }\n\n    public void CloseNode()\n    {\n        HideAgentPicker();\n\n        if (nodePanel) nodePanel.SetActive(false);\n        _currentNodeId = null;\n\n        // 恢复到当前仍开着的 top modal；否则关 dim\n        SetModalTop(GetTopModal());\n    }\n\n    // ========= Event Panel =========\n    public void OpenEventIfAny()\n    {\n        if (GameController.I == null) return;\n\n        var list = GameController.I.State.PendingEvents;\n        if (list == null || list.Count == 0) return;\n\n        if (!eventPanel)\n        {\n            Debug.LogError(\"[UIPanelRoot] eventPanel is NULL (Inspector 没拖场景实例)\", this);\n            return;\n        }\n\n        // 幂等：已经开着就不重复 Show\n        if (eventPanel.gameObject.activeSelf) return;\n\n        eventPanel.gameObject.SetActive(true);\n        eventPanel.Show(list[0]);\n\n        SetModalTop((RectTransform)eventPanel.transform);\n    }\n\n    public void CloseEvent()\n    {\n        if (eventPanel) eventPanel.gameObject.SetActive(false);\n        SetModalTop(GetTopModal());\n    }\n\n    // ========= News Panel =========\n    public void OpenNews()\n    {\n        if (!newsPanel)\n        {\n            Debug.LogError(\"[UIPanelRoot] newsPanel is NULL（Inspector 没拖）\", this);\n            return;\n        }\n\n        newsPanel.Show();\n        SetModalTop((RectTransform)newsPanel.transform);\n    }\n\n    public void CloseNews()\n    {\n        if (newsPanel) newsPanel.Hide();\n        SetModalTop(GetTopModal());\n    }\n\n    // ========= 统一关闭（可绑在 dim 点击上） =========\n    public void CloseAll()\n    {\n        HideAgentPicker();\n\n        if (eventPanel) eventPanel.gameObject.SetActive(false);\n        if (newsPanel) newsPanel.Hide();\n        if (nodePanel) nodePanel.SetActive(false);\n\n        _currentNodeId = null;\n        SetModalTop(null);\n    }\n\n    // ===================== Dispatch UI: OnInvestigate/OnContain =====================\n    public void OnInvestigate()\n    {\n        if (string.IsNullOrEmpty(_currentNodeId)) return;\n\n        if (!useAgentPicker)\n        {\n            AssignInvestigate(\"A1\");\n            return;\n        }\n\n        ShowAgentPicker(AssignMode.Investigate);\n    }\n\n    public void OnContain()\n    {\n        if (string.IsNullOrEmpty(_currentNodeId)) return;\n\n        if (!useAgentPicker)\n        {\n            AssignContain(\"A1\");\n            return;\n        }\n\n        ShowAgentPicker(AssignMode.Contain);\n    }\n\n    // 旧兼容：如果你场景里还保留了 A1/A2/A3 按钮（目前是 Inactive）:contentReference[oaicite:3]{index=3}\n    public void AssignInvestigate_A1() => AssignInvestigate(\"A1\");\n    public void AssignInvestigate_A2() => AssignInvestigate(\"A2\");\n    public void AssignInvestigate_A3() => AssignInvestigate(\"A3\");\n\n    public void AssignContain_A1() => AssignContain(\"A1\");\n    public void AssignContain_A2() => AssignContain(\"A2\");\n    public void AssignContain_A3() => AssignContain(\"A3\");\n\n    void AssignInvestigate(string agentId)\n    {\n        if (GameController.I == null || string.IsNullOrEmpty(_currentNodeId)) return;\n        GameController.I.AssignInvestigate(_currentNodeId, agentId);\n        RefreshNodePanel();\n    }\n\n    void AssignContain(string agentId)\n    {\n        if (GameController.I == null || string.IsNullOrEmpty(_currentNodeId)) return;\n        GameController.I.AssignContain(_currentNodeId, agentId);\n        RefreshNodePanel();\n    }\n\n    // ===================== Agent Picker Impl (simple, stable) =====================\n    void EnsureAgentPickerCreated()\n    {\n        if (_agentPickerRoot != null) return;\n\n        var parent = nodePanel ? nodePanel.transform : transform;\n\n        _agentPickerRoot = new GameObject(\"AgentPicker\",\n            typeof(RectTransform),\n            typeof(CanvasRenderer),\n            typeof(Image));\n\n        _agentPickerRoot.transform.SetParent(parent, false);\n        _agentPickerRoot.SetActive(false);\n\n        var rootRT = (RectTransform)_agentPickerRoot.transform;\n        rootRT.anchorMin = new Vector2(0.5f, 0.5f);\n        rootRT.anchorMax = new Vector2(0.5f, 0.5f);\n        rootRT.pivot = new Vector2(0.5f, 0.5f);\n        rootRT.sizeDelta = pickerSize;\n        rootRT.anchoredPosition = Vector2.zero;\n\n        var bg = _agentPickerRoot.GetComponent<Image>();\n        bg.color = new Color(0f, 0f, 0f, 0.92f);\n        bg.raycastTarget = true;\n\n        // Title\n        var titleGO = new GameObject(\"Title\", typeof(RectTransform), typeof(CanvasRenderer), typeof(TextMeshProUGUI));\n        titleGO.transform.SetParent(_agentPickerRoot.transform, false);\n        var titleRT = (RectTransform)titleGO.transform;\n        titleRT.anchorMin = new Vector2(0f, 1f);\n        titleRT.anchorMax = new Vector2(1f, 1f);\n        titleRT.pivot = new Vector2(0.5f, 1f);\n        titleRT.sizeDelta = new Vector2(0f, 80f);\n        titleRT.anchoredPosition = new Vector2(0f, -10f);\n\n        _pickerTitle = titleGO.GetComponent<TextMeshProUGUI>();\n        _pickerTitle.fontSize = 42;\n        _pickerTitle.alignment = TextAlignmentOptions.Center;\n\n        // Close button\n        var closeGO = new GameObject(\"Close\", typeof(RectTransform), typeof(CanvasRenderer), typeof(Image), typeof(Button));\n        closeGO.transform.SetParent(_agentPickerRoot.transform, false);\n        var closeRT = (RectTransform)closeGO.transform;\n        closeRT.anchorMin = new Vector2(1f, 1f);\n        closeRT.anchorMax = new Vector2(1f, 1f);\n        closeRT.pivot = new Vector2(1f, 1f);\n        closeRT.sizeDelta = new Vector2(80f, 80f);\n        closeRT.anchoredPosition = new Vector2(-10f, -10f);\n\n        closeGO.GetComponent<Image>().color = new Color(1f, 1f, 1f, 0.08f);\n        closeGO.GetComponent<Button>().onClick.AddListener(HideAgentPicker);\n\n        var closeTxtGO = new GameObject(\"Text\", typeof(RectTransform), typeof(CanvasRenderer), typeof(TextMeshProUGUI));\n        closeTxtGO.transform.SetParent(closeGO.transform, false);\n        var closeTxtRT = (RectTransform)closeTxtGO.transform;\n        closeTxtRT.anchorMin = Vector2.zero;\n        closeTxtRT.anchorMax = Vector2.one;\n        closeTxtRT.sizeDelta = Vector2.zero;\n\n        var closeTxt = closeTxtGO.GetComponent<TextMeshProUGUI>();\n        closeTxt.text = \"X\";\n        closeTxt.fontSize = 40;\n        closeTxt.alignment = TextAlignmentOptions.Center;\n\n        // Scroll View\n        var scrollGO = new GameObject(\"Scroll\", typeof(RectTransform), typeof(CanvasRenderer), typeof(Image), typeof(ScrollRect));\n        scrollGO.transform.SetParent(_agentPickerRoot.transform, false);\n\n        var scrollRT = (RectTransform)scrollGO.transform;\n        scrollRT.anchorMin = new Vector2(0f, 0f);\n        scrollRT.anchorMax = new Vector2(1f, 1f);\n        scrollRT.offsetMin = new Vector2(20f, 20f);\n        scrollRT.offsetMax = new Vector2(-20f, -110f);\n\n        scrollGO.GetComponent<Image>().color = new Color(1f, 1f, 1f, 0.04f);\n\n        _pickerScroll = scrollGO.GetComponent<ScrollRect>();\n        _pickerScroll.horizontal = false;\n        _pickerScroll.movementType = ScrollRect.MovementType.Clamped;\n        _pickerScroll.scrollSensitivity = 30;\n\n        // Viewport\n        var vpGO = new GameObject(\"Viewport\", typeof(RectTransform), typeof(CanvasRenderer), typeof(Image), typeof(Mask));\n        vpGO.transform.SetParent(scrollGO.transform, false);\n        var vpRT = (RectTransform)vpGO.transform;\n        vpRT.anchorMin = Vector2.zero;\n        vpRT.anchorMax = Vector2.one;\n        vpRT.sizeDelta = Vector2.zero;\n\n        vpGO.GetComponent<Image>().color = new Color(1f, 1f, 1f, 0.02f);\n        vpGO.GetComponent<Mask>().showMaskGraphic = false;\n\n        _pickerScroll.viewport = vpRT;\n\n        // Content\n        var contentGO = new GameObject(\"Content\",\n            typeof(RectTransform),\n            typeof(VerticalLayoutGroup),\n            typeof(ContentSizeFitter));\n\n        contentGO.transform.SetParent(vpGO.transform, false);\n        _pickerContent = (RectTransform)contentGO.transform;\n        _pickerContent.anchorMin = new Vector2(0f, 1f);\n        _pickerContent.anchorMax = new Vector2(1f, 1f);\n        _pickerContent.pivot = new Vector2(0.5f, 1f);\n        _pickerContent.anchoredPosition = Vector2.zero;\n        _pickerContent.sizeDelta = new Vector2(0f, 0f);\n\n        var vlg = contentGO.GetComponent<VerticalLayoutGroup>();\n        vlg.childAlignment = TextAnchor.UpperCenter;\n        vlg.spacing = 12f;\n        vlg.padding = new RectOffset(12, 12, 12, 12);\n        vlg.childControlHeight = true;\n        vlg.childControlWidth = true;\n        vlg.childForceExpandHeight = false;\n        vlg.childForceExpandWidth = true;\n\n        var csf = contentGO.GetComponent<ContentSizeFitter>();\n        csf.horizontalFit = ContentSizeFitter.FitMode.Unconstrained;\n        csf.verticalFit = ContentSizeFitter.FitMode.PreferredSize;\n\n        _pickerScroll.content = _pickerContent;\n    }\n\n    void ShowAgentPicker(AssignMode mode)\n    {\n        EnsureAgentPickerCreated();\n        _pickerMode = mode;\n\n        if (_pickerTitle)\n            _pickerTitle.text = mode == AssignMode.Investigate ? \"Select Agent - Investigate\" : \"Select Agent - Contain\";\n\n        // 清空旧条目\n        for (int i = _pickerContent.childCount - 1; i >= 0; i--)\n            Destroy(_pickerContent.GetChild(i).gameObject);\n\n        var ids = GetAgentIds();\n        foreach (var id in ids)\n            CreateAgentButton(id);\n\n        _agentPickerRoot.SetActive(true);\n        _agentPickerRoot.transform.SetAsLastSibling();\n\n        // NodePanel 仍当 top\n        if (nodePanel && nodePanel.activeSelf)\n            SetModalTop((RectTransform)nodePanel.transform);\n    }\n\n    void HideAgentPicker()\n    {\n        if (_agentPickerRoot) _agentPickerRoot.SetActive(false);\n    }\n\n    List<string> GetAgentIds()\n    {\n        var result = new List<string>();\n\n        try\n        {\n            var s = GameController.I != null ? GameController.I.State : null;\n            if (s != null && s.Agents != null && s.Agents.Count > 0)\n                result.AddRange(s.Agents.Select(a => a.Id));\n        }\n        catch { /* ignore */ }\n\n        if (result.Count == 0 && fallbackAgentIds != null)\n            result.AddRange(fallbackAgentIds);\n\n        // 去重\n        var seen = new HashSet<string>();\n        var uniq = new List<string>();\n        foreach (var id in result)\n            if (!string.IsNullOrEmpty(id) && seen.Add(id)) uniq.Add(id);\n\n        return uniq;\n    }\n\n    void CreateAgentButton(string agentId)\n    {\n        var row = new GameObject($\"Agent_{agentId}\",\n            typeof(RectTransform),\n            typeof(CanvasRenderer),\n            typeof(Image),\n            typeof(Button),\n            typeof(LayoutElement));\n\n        row.transform.SetParent(_pickerContent, false);\n\n        var le = row.GetComponent<LayoutElement>();\n        le.preferredHeight = 110f;\n\n        row.GetComponent<Image>().color = new Color(1f, 1f, 1f, 0.10f);\n\n        var btn = row.GetComponent<Button>();\n        btn.onClick.AddListener(() =>\n        {\n            HideAgentPicker();\n            if (_pickerMode == AssignMode.Investigate) AssignInvestigate(agentId);\n            else AssignContain(agentId);\n        });\n\n        var txtGO = new GameObject(\"Text\", typeof(RectTransform), typeof(CanvasRenderer), typeof(TextMeshProUGUI));\n        txtGO.transform.SetParent(row.transform, false);\n\n        var rt = (RectTransform)txtGO.transform;\n        rt.anchorMin = Vector2.zero;\n        rt.anchorMax = Vector2.one;\n        rt.offsetMin = new Vector2(20f, 10f);\n        rt.offsetMax = new Vector2(-20f, -10f);\n\n        var t = txtGO.GetComponent<TextMeshProUGUI>();\n        t.enableWordWrapping = true;\n        t.fontSize = 32;\n        t.alignment = TextAlignmentOptions.MidlineLeft;\n        t.text = agentId;\n    }\n\n#if UNITY_EDITOR || DEVELOPMENT_BUILD\n    void LateUpdate()\n    {\n        // 轻量自检：有 modal 开着时 dim 不应是最后一个 sibling\n        var top = GetTopModal();\n        if (top == null) return;\n\n        if (!dim || !dim.activeSelf)\n        {\n            Debug.LogWarning(\"[Modal] Expected dim active but it is not\", this);\n            return;\n        }\n\n        if (dim.transform.GetSiblingIndex() == dim.transform.parent.childCount - 1)\n            Debug.LogWarning(\"[Modal] dim is last sibling (may cover top panel)\", this);\n    }\n#endif\n}"
        },
        {
            "id": 21,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "// <EXPORT_BLOCK>\nusing System;\nusing Core;\nusing TMPro;\nusing UnityEngine;\nusing UnityEngine.UI;\n\npublic class EventPanel : MonoBehaviour\n{\n    [SerializeField] private TMP_Text titleText;\n    [SerializeField] private TMP_Text descText;\n    [SerializeField] private Transform optionRoot;\n    [SerializeField] private Button optionPrefab;\n    [SerializeField] private TMP_Text resultText;\n\n    private string _eventId;\n\n    public void Show(PendingEvent ev)\n    {\n        gameObject.SetActive(true);\n        _eventId = ev.Id;\n\n        titleText.text = ev.Title;\n        descText.text = ev.Desc;\n        if (resultText) resultText.text = \"\";\n\n        foreach (Transform c in optionRoot) Destroy(c.gameObject);\n\n        foreach (var opt in ev.Options)\n        {\n            var b = Instantiate(optionPrefab, optionRoot);\n            b.GetComponentInChildren<TMP_Text>().text = opt.Text;\n            b.onClick.AddListener(() => OnPick(opt.Id));\n        }\n    }\n\n    void OnPick(string optionId)\n    {\n        var (success, text) = GameController.I.ResolveEvent(_eventId, optionId);\n        if (resultText) resultText.text = text;\n\n        // 简单做法：选完立即关闭（你也可以停留显示结果再关）\nUIPanelRoot.I?.CloseEvent();\nUIPanelRoot.I?.RefreshNodePanel();\n\n\n    }\n}\n\n// </EXPORT_BLOCK>\n"
        },
        {
            "id": 22,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "// <EXPORT_BLOCK>\nusing System;\nusing System.Linq;\nusing Core;\nusing UnityEngine;\n\npublic class GameController : MonoBehaviour\n{\n    public static GameController I { get; private set; }\n\n    public GameState State { get; private set; } = new GameState();\n    public event Action OnStateChanged;\n\n    private System.Random _rng;\n\n    [Header(\"Debug Seed (same seed => same run)\")]\n    [SerializeField] private int seed = 12345;\n\n    private void Awake()\n    {\n        if (I != null) { Destroy(gameObject); return; }\n        I = this;\n        DontDestroyOnLoad(gameObject);\n\n        _rng = new System.Random(seed);\n\n        // ---- 初始干员（先写死，后面再换 Data/ScriptableObject）----\n        State.Agents.Add(new AgentState { Id = \"A1\", Name = \"Alice\", Perception = 6, Operation = 5, Resistance = 5, Power = 4 });\n        State.Agents.Add(new AgentState { Id = \"A2\", Name = \"Bob\",   Perception = 4, Operation = 7, Resistance = 5, Power = 6 });\n        State.Agents.Add(new AgentState { Id = \"A3\", Name = \"Chen\",  Perception = 5, Operation = 5, Resistance = 7, Power = 4 });\n\n        // ---- 初始节点（先写死）----\n        State.Nodes.Add(new NodeState { Id = \"N1\", Name = \"节点1\", X = 0.35f, Y = 0.42f });\n        State.Nodes.Add(new NodeState { Id = \"N2\", Name = \"节点2\", X = 0.62f, Y = 0.33f });\n        State.Nodes.Add(new NodeState { Id = \"N3\", Name = \"节点3\", X = 0.48f, Y = 0.58f });\n\n        Notify();\n    }\n\n    public void Notify() => OnStateChanged?.Invoke();\n\n    public NodeState GetNode(string nodeId)\n        => State.Nodes.FirstOrDefault(n => n.Id == nodeId);\n\n    public AgentState GetAgent(string agentId)\n        => State.Agents.FirstOrDefault(a => a.Id == agentId);\n\n    public void EndDay()\n    {\n        Sim.StepDay(State, _rng);\n        Notify();\n    }\n\n    public void AssignInvestigate(string nodeId, string agentId)\n    {\n        var n = GetNode(nodeId);\n        if (n == null) return;\n\n        n.Status = NodeStatus.Investigating;\n        n.AssignedAgentId = agentId;\n        n.InvestigateProgress = 0f;\n\n        Notify();\n    }\n\n    public void AssignContain(string nodeId, string agentId)\n    {\n        var n = GetNode(nodeId);\n        if (n == null) return;\n\n        n.Status = NodeStatus.Containing;\n        n.AssignedAgentId = agentId;\n        n.ContainProgress = 0f;\n\n        Notify();\n    }\n\n    public (bool success, string text) ResolveEvent(string eventId, string optionId)\n    {\n        var res = Sim.ResolveEvent(State, eventId, optionId, _rng);\n        Notify();\n        return res;\n    }\n}\n\n// <FORCE_WITHDRAW_EXT>\n/// <summary>\n/// Dispatch rules (extensions):\n/// - Progress==0: can freely change assignee / switch Investigate<->Contain.\n/// - Progress>0: cannot change; must ForceWithdraw first (treated as failure; no extra penalty, only time/progress lost).\n/// - Prevent assigning same agent to multiple nodes (if other node is Investigating/Containing).\n/// </summary>\npublic static class GameControllerTaskExt\n{\n    public struct AssignResult\n    {\n        public bool ok;\n        public string reason;\n\n        public static AssignResult Ok() => new AssignResult { ok = true, reason = \"\" };\n        public static AssignResult Fail(string r) => new AssignResult { ok = false, reason = r };\n    }\n\n    public static bool IsTaskStarted(this GameController gc, string nodeId)\n    {\n        var n = gc?.GetNode(nodeId);\n        if (n == null) return false;\n        if (n.Status == NodeStatus.Investigating) return n.InvestigateProgress > 0.0001f;\n        if (n.Status == NodeStatus.Containing) return n.ContainProgress > 0.0001f;\n        return false;\n    }\n\n    static bool HasTask(NodeState n)\n        => n != null && (n.Status == NodeStatus.Investigating || n.Status == NodeStatus.Containing);\n\n    static float GetProgress(NodeState n)\n    {\n        if (n == null) return 0f;\n        if (n.Status == NodeStatus.Investigating) return n.InvestigateProgress;\n        if (n.Status == NodeStatus.Containing) return n.ContainProgress;\n        return 0f;\n    }\n\n    static bool IsAgentBusyOnOtherNode(GameController gc, string agentId, string currentNodeId)\n    {\n        if (gc == null || gc.State == null || gc.State.Nodes == null) return false;\n\n        foreach (var node in gc.State.Nodes)\n        {\n            if (node == null) continue;\n            if (node.Id == currentNodeId) continue;\n            if (node.AssignedAgentId != agentId) continue;\n\n            // 只要在 Investigating/Containing，就算占用（即使进度==0，也避免一人多派）\n            if (node.Status == NodeStatus.Investigating || node.Status == NodeStatus.Containing)\n                return true;\n        }\n        return false;\n    }\n\n    public static bool ForceWithdraw(this GameController gc, string nodeId)\n    {\n        if (gc == null || string.IsNullOrEmpty(nodeId)) return false;\n        var n = gc.GetNode(nodeId);\n        if (!HasTask(n)) return false;\n\n        // 撤回=任务失败：清空派遣与进度；不额外惩罚（时间/过程中影响已体现在别处）\n        n.AssignedAgentId = null;\n        n.InvestigateProgress = 0f;\n        n.ContainProgress = 0f;\n        n.Status = default(NodeStatus);\n\n        gc.Notify();\n        return true;\n    }\n\n    public static AssignResult TryAssignInvestigate(this GameController gc, string nodeId, string agentId)\n        => TryAssign(gc, nodeId, agentId, NodeStatus.Investigating);\n\n    public static AssignResult TryAssignContain(this GameController gc, string nodeId, string agentId)\n        => TryAssign(gc, nodeId, agentId, NodeStatus.Containing);\n\n    static AssignResult TryAssign(GameController gc, string nodeId, string agentId, NodeStatus targetStatus)\n    {\n        if (gc == null) return AssignResult.Fail(\"GameController is null\");\n        if (string.IsNullOrEmpty(nodeId)) return AssignResult.Fail(\"nodeId 为空\");\n        if (string.IsNullOrEmpty(agentId)) return AssignResult.Fail(\"agentId 为空\");\n\n        var n = gc.GetNode(nodeId);\n        if (n == null) return AssignResult.Fail(\"节点不存在\");\n\n        // 忙于别的节点则不允许\n        if (IsAgentBusyOnOtherNode(gc, agentId, nodeId))\n            return AssignResult.Fail(\"该干员正在其他节点执行任务，不能重复派遣\");\n\n        bool hasTask = HasTask(n);\n\n        if (hasTask)\n        {\n            bool started = GetProgress(n) > 0.0001f;\n\n            // 已开始：禁止直接换人/换类型（只允许重复点击同人同类型=OK）\n            if (started)\n            {\n                if (n.AssignedAgentId == agentId && n.Status == targetStatus)\n                    return AssignResult.Ok();\n\n                return AssignResult.Fail(\"任务已开始：只能强制撤回后再更换派遣\");\n            }\n\n            // 未开始：允许自由换人、允许切换任务类型\n            n.Status = targetStatus;\n            n.AssignedAgentId = agentId;\n            n.InvestigateProgress = 0f;\n            n.ContainProgress = 0f;\n\n            gc.Notify();\n            return AssignResult.Ok();\n        }\n\n        // Idle：直接调用原有接口开始任务\n        if (targetStatus == NodeStatus.Investigating)\n            gc.AssignInvestigate(nodeId, agentId);\n        else\n            gc.AssignContain(nodeId, agentId);\n\n        return AssignResult.Ok();\n    }\n}\n// </FORCE_WITHDRAW_EXT>\n\n// </EXPORT_BLOCK>"
        },
        {
            "id": 23,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "using System;\nusing System.Linq;\n\nnamespace Core\n{\n    public static class Sim\n    {\n        public static void StepDay(GameState s, Random rng)\n        {\n            s.Day += 1;\n            s.News.Add($\"Day {s.Day}: 日结算开始\");\n\n            // 1) 平静节点 15% 生成异常（示例）\n            foreach (var n in s.Nodes)\n            {\n                if (n.Status == NodeStatus.Calm && !n.HasAnomaly)\n                {\n                    if (rng.NextDouble() < 0.15)\n                    {\n                        n.HasAnomaly = true;\n                        n.AnomalyLevel = 1;\n                        s.News.Add($\"- {n.Name} 出现异常迹象\");\n                    }\n                }\n            }\n\n            // 2) 推进调查/收容（有事件则暂停推进）\n            foreach (var n in s.Nodes)\n            {\n                if (n.Status != NodeStatus.Investigating && n.Status != NodeStatus.Containing) continue;\n                if (s.PendingEvents.Any(e => e.NodeId == n.Id)) continue;\n\n                // 12% 概率生成事件\n                if (rng.NextDouble() < 0.12)\n                {\n                    var ev = GenerateEvent(n);\n                    s.PendingEvents.Add(ev);\n                    s.News.Add($\"- {n.Name} 发生突发事件：{ev.Title}\");\n                    continue;\n                }\n\n                var agent = GetAssignedAgent(s, n);\n                float delta = CalcDailyProgressDelta(n, agent, rng);\n\n                if (n.Status == NodeStatus.Investigating)\n                {\n                    n.InvestigateProgress = Clamp01(n.InvestigateProgress + delta);\n                    if (n.InvestigateProgress >= 1f)\n                    {\n                        n.Status = NodeStatus.Containing;\n                        n.ContainProgress = 0f;\n                        s.News.Add($\"- {n.Name} 调查完成，转入收容阶段\");\n                    }\n                }\n                else\n                {\n                    n.ContainProgress = Clamp01(n.ContainProgress + delta);\n                    if (n.ContainProgress >= 1f)\n                    {\n                        n.Status = NodeStatus.Secured;\n                        n.AssignedAgentId = null;\n\n                        int reward = 200 + 50 * n.AnomalyLevel;\n                        s.Money += reward;\n                        s.Panic = Math.Max(0, s.Panic - 5);\n                        s.News.Add($\"- {n.Name} 收容成功（+$ {reward}, -Panic 5）\");\n                    }\n                }\n            }\n\n            // 3) 恐慌按未收容异常数增长\n            int activeAnomaly = s.Nodes.Count(n => n.HasAnomaly && n.Status != NodeStatus.Secured);\n            s.Panic = ClampInt(s.Panic + activeAnomaly, 0, 100);\n\n            // 4) 基础收入\n            s.Money += 50;\n\n            s.News.Add($\"Day {s.Day}: 日结算结束（Money={s.Money}, Panic={s.Panic}）\");\n        }\n\n        public static (bool success, string text) ResolveEvent(GameState s, string eventId, string optionId, Random rng)\n        {\n            var ev = s.PendingEvents.FirstOrDefault(e => e.Id == eventId);\n            if (ev == null) return (false, \"事件不存在\");\n\n            var opt = ev.Options.FirstOrDefault(o => o.Id == optionId);\n            if (opt == null) return (false, \"选项不存在\");\n\n            var node = s.Nodes.First(n => n.Id == ev.NodeId);\n            var agent = GetAssignedAgent(s, node);\n\n            float rate = CalcSuccessRate(opt, agent);\n            bool success = rng.NextDouble() < rate;\n\n            if (success)\n            {\n                s.Money += opt.MoneyOnSuccess;\n                s.Panic = ClampInt(s.Panic + opt.PanicOnSuccess, 0, 100);\n                ApplyProgressDelta(ev.Kind, node, opt.ProgressDeltaOnSuccess);\n            }\n            else\n            {\n                s.Money += opt.MoneyOnFail;\n                s.Panic = ClampInt(s.Panic + opt.PanicOnFail, 0, 100);\n                ApplyProgressDelta(ev.Kind, node, opt.ProgressDeltaOnFail);\n            }\n\n            string resultText = $\"{(success ? \"成功\" : \"失败\")}（成功率 {Math.Round(rate * 100)}%）: {opt.Text}\";\n            s.News.Add($\"- {node.Name} 事件结果：{ev.Title} → {resultText}\");\n\n            s.PendingEvents.Remove(ev);\n            return (success, resultText);\n        }\n\n        static PendingEvent GenerateEvent(NodeState n)\n        {\n            bool inv = n.Status == NodeStatus.Investigating;\n            var ev = new PendingEvent\n            {\n                Id = \"EV_\" + Guid.NewGuid().ToString(\"N\")[..8],\n                NodeId = n.Id,\n                Kind = inv ? EventKind.Investigate : EventKind.Contain,\n                Title = inv ? \"目击者失控\" : \"收容设施异常震动\",\n                Desc = inv ? \"当地目击者情绪激动，可能引发恐慌扩散。\" : \"设施监测到异常震动，继续操作可能扩大损失。\"\n            };\n\n            ev.Options.Add(new DecisionOption\n            {\n                Id = \"A\",\n                Text = inv ? \"安抚并隔离目击者\" : \"暂缓推进，优先加固\",\n                CheckAttr = inv ? \"Perception\" : \"Resistance\",\n                Threshold = 6,\n                BaseSuccess = 0.55f,\n                PanicOnSuccess = -2,\n                PanicOnFail = +4,\n                ProgressDeltaOnSuccess = +0.02f,\n                ProgressDeltaOnFail = -0.06f\n            });\n\n            ev.Options.Add(new DecisionOption\n            {\n                Id = \"B\",\n                Text = inv ? \"强制驱散，快速清场\" : \"继续推进，赌它只是误报\",\n                CheckAttr = inv ? \"Power\" : \"Operation\",\n                Threshold = 7,\n                BaseSuccess = 0.45f,\n                MoneyOnSuccess = +50,\n                MoneyOnFail = -80,\n                PanicOnSuccess = +1,\n                PanicOnFail = +6,\n                ProgressDeltaOnSuccess = +0.05f,\n                ProgressDeltaOnFail = -0.10f\n            });\n\n            return ev;\n        }\n\n        static AgentState GetAssignedAgent(GameState s, NodeState n)\n        {\n            if (string.IsNullOrEmpty(n.AssignedAgentId)) return null;\n            return s.Agents.FirstOrDefault(a => a.Id == n.AssignedAgentId);\n        }\n\n        static float CalcDailyProgressDelta(NodeState n, AgentState agent, Random rng)\n        {\n            float baseDelta = 0.12f;\n            int stat = 0;\n            if (agent != null)\n                stat = (n.Status == NodeStatus.Investigating) ? agent.Perception : agent.Operation;\n\n            float statBonus = stat * 0.01f; // 5 => +0.05\n            float noise = (float)(rng.NextDouble() * 0.02 - 0.01); // -0.01~+0.01\n            return Math.Max(0.02f, baseDelta + statBonus + noise);\n        }\n\n        static float CalcSuccessRate(DecisionOption opt, AgentState agent)\n        {\n            int val = 0;\n            if (agent != null)\n            {\n                val = opt.CheckAttr switch\n                {\n                    \"Perception\" => agent.Perception,\n                    \"Operation\" => agent.Operation,\n                    \"Resistance\" => agent.Resistance,\n                    \"Power\" => agent.Power,\n                    _ => 0\n                };\n            }\n\n            float rate = opt.BaseSuccess + (val - opt.Threshold) * 0.05f;\n            return Clamp01(rate);\n        }\n\n        static void ApplyProgressDelta(EventKind kind, NodeState node, float delta)\n        {\n            if (kind == EventKind.Investigate)\n                node.InvestigateProgress = Clamp01(node.InvestigateProgress + delta);\n            else\n                node.ContainProgress = Clamp01(node.ContainProgress + delta);\n        }\n\n        static float Clamp01(float v) => v < 0 ? 0 : (v > 1 ? 1 : v);\n        static int ClampInt(int v, int min, int max) => v < min ? min : (v > max ? max : v);\n    }\n}"
        }
    ]
}