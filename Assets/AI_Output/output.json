{
    "batch_id": "export_ui_prefabs_and_scripts",
    "results": [
        {
            "id": 1,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "Prefab loaded."
        },
        {
            "id": 2,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "Prefab loaded."
        },
        {
            "id": 3,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "[Opened Prefab] Assets/Prefabs/UI/AgentPicker.prefab\r\n--AgentPicker [RectTransform,CanvasRenderer,Image,CanvasGroup]\r\n----WindowFrame [RectTransform,CanvasRenderer,Image,Outline]\r\n------Header [RectTransform,CanvasRenderer,Image]\r\n--------TitleText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n--------CloseBT [RectTransform,CanvasRenderer,Image,Button]\r\n----------X [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n------Footer [RectTransform,CanvasRenderer,Image]\r\n--------SelectedCountText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n--------ConfirmBT [RectTransform,CanvasRenderer,Image,Button]\r\n----------Text [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n------ScrollView [RectTransform,CanvasRenderer,Image,ScrollRect]\r\n--------Viewport [RectTransform,CanvasRenderer,Image,Mask]\r\n----------Content [RectTransform,VerticalLayoutGroup,ContentSizeFitter]\r\n[Opened Prefab] Assets/Prefabs/UI/AgentPickerItem.prefab\r\n--AgentPickerItem [RectTransform,CanvasRenderer,Image,Button]\r\n----AccentBar [RectTransform,CanvasRenderer,Image]\r\n----NameText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n----AttrText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n----BusyTagText [RectTransform,CanvasRenderer,TextMeshProUGUI]\r\n----SelectedMark (Inactive) [RectTransform,CanvasRenderer,Image]\r\n"
        },
        {
            "id": 4,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing Core;\nusing TMPro;\nusing UnityEngine;\nusing UnityEngine.UI;\n\npublic class UIPanelRoot : MonoBehaviour\n{\n    public static UIPanelRoot I { get; private set; }\n\n    [Header(\"Modal\")]\n    [SerializeField] private GameObject dim;\n\n    [Header(\"Node Panel (drag NodePanel root)\")]\n    [SerializeField] private GameObject nodePanel;     // 拖 NodePanel（父物体）\n    [SerializeField] private TMP_Text nodeTitle;        // 拖 NodePanel/Panel/TItle\n    [SerializeField] private TMP_Text nodeStatus;       // 拖 NodePanel/Panel/Status\n    [SerializeField] private TMP_Text progressText;     // 拖 NodePanel/Panel/progressText\n\n    [Header(\"Node Panel Buttons (bind in code; Inspector OnClick should be empty)\")]\n    [SerializeField] private Button investigateButton;  // 拖 NodePanel/Panel/InvestigateBT\n    [SerializeField] private Button containButton;      // 拖 NodePanel/Panel/ContainBT\n    [SerializeField] private Button closeNodeButton;    // 拖 NodePanel/Panel/CloseBT\n\n    [Header(\"Event Panel\")]\n    [SerializeField] private EventPanel eventPanel;     // 拖场景里的 EventPanel 实例\n\n    [Header(\"News Panel\")]\n    [SerializeField] private NewsPanel newsPanel;       // 拖场景里的 NewsPanel 实例\n    [Header(\"News Panel Buttons (bind in code)\")]\n    [SerializeField] private Button closeNewsButton; // 拖 NewsPanel 里的关闭按钮（可选，没拖也会自动找）\n\n\n    [Header(\"Confirm/Withdraw (Milestone 1; optional in Milestone 0)\")]\n    [SerializeField] private ConfirmDialog confirmDialog;\n    [SerializeField] private Button withdrawButton;\n    [SerializeField] private TMP_Text withdrawButtonLabel;\n\n\n    [SerializeField] private Button dimButton;\n\n\n    // ===================== Agent Picker (existing approach) =====================\n    [Header(\"Dispatch UI (Agent Picker)\")]\n    [SerializeField] private bool useAgentPicker = true;\n    [SerializeField] private string[] fallbackAgentIds = new[] { \"A1\", \"A2\", \"A3\" };\n    [SerializeField] private Vector2 pickerSize = new Vector2(900, 600);\n\n    enum AssignMode { Investigate, Contain }\n\n    private GameObject _agentPickerRoot;\n    private TMP_Text _pickerTitle;\n    private ScrollRect _pickerScroll;\n    private RectTransform _pickerContent;\n    private AssignMode _pickerMode;\n\n    // ===========================================================================\n\n    private string _currentNodeId;\n\n    private void Awake()\n    {\n        I = this;\n\n        if (!ValidateBindings())\n        {\n            enabled = false;\n            return;\n        }\n\n        AutoWireNodePanelButtonsIfMissing();\n        BindNodePanelButtonsInCode();\n        AutoWireNewsPanelButtonsIfMissing();\n        BindNewsPanelButtonsInCode();\n\n        if (!dimButton && dim) dimButton = dim.GetComponent<Button>();\n        if (dimButton)\n        {\n            dimButton.onClick.RemoveAllListeners();\n            dimButton.onClick.AddListener(CloseAll);\n        }\n        else\n        {\n            Debug.LogWarning(\"[UIPanelRoot] Dim has no Button; click-to-close disabled.\", this);\n        }\n\n\n        ResetUI();\n        EnsureAgentPickerCreated();\n    }\n\n    private void OnEnable()\n    {\n        if (GameController.I != null)\n            GameController.I.OnStateChanged += OnGameStateChanged;\n\n        OnGameStateChanged();\n    }\n\n    private void OnDisable()\n    {\n        if (GameController.I != null)\n            GameController.I.OnStateChanged -= OnGameStateChanged;\n    }\n\n    bool ValidateBindings()\n    {\n        bool ok = true;\n\n        void Req(object o, string name)\n        {\n            if (o == null)\n            {\n                Debug.LogError($\"[UIPanelRoot] Missing binding: {name}\", this);\n                ok = false;\n            }\n        }\n\n        Req(dim, nameof(dim));\n        Req(nodePanel, nameof(nodePanel));\n        Req(nodeTitle, nameof(nodeTitle));\n        Req(nodeStatus, nameof(nodeStatus));\n        Req(progressText, nameof(progressText));\n        Req(eventPanel, nameof(eventPanel));\n        Req(newsPanel, nameof(newsPanel));\n\n        // Milestone 0: confirm/withdraw 可为空（先不硬要求）\n        if (!confirmDialog) Debug.LogWarning(\"[UIPanelRoot] confirmDialog not bound (OK in Milestone 0)\", this);\n        if (!withdrawButton) Debug.LogWarning(\"[UIPanelRoot] withdrawButton not bound (OK in Milestone 0)\", this);\n\n        return ok;\n    }\n\n    void AutoWireNodePanelButtonsIfMissing()\n    {\n        // 场景层级：NodePanel/Panel/InvestigateBT, ContainBT, CloseBT :contentReference[oaicite:2]{index=2}\n        if (!nodePanel) return;\n\n        var panel = nodePanel.transform.Find(\"Panel\");\n        if (!panel) return;\n\n        if (!investigateButton)\n        {\n            var t = panel.Find(\"InvestigateBT\");\n            if (t) investigateButton = t.GetComponent<Button>();\n        }\n\n        if (!containButton)\n        {\n            var t = panel.Find(\"ContainBT\");\n            if (t) containButton = t.GetComponent<Button>();\n        }\n\n        if (!closeNodeButton)\n        {\n            var t = panel.Find(\"CloseBT\");\n            if (t) closeNodeButton = t.GetComponent<Button>();\n        }\n    }\n\n    void BindNodePanelButtonsInCode()\n    {\n        if (investigateButton)\n        {\n            investigateButton.onClick.RemoveAllListeners();\n            investigateButton.onClick.AddListener(OnInvestigate);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] investigateButton not bound (expected NodePanel/Panel/InvestigateBT)\", this);\n\n        if (containButton)\n        {\n            containButton.onClick.RemoveAllListeners();\n            containButton.onClick.AddListener(OnContain);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] containButton not bound (expected NodePanel/Panel/ContainBT)\", this);\n\n        if (closeNodeButton)\n        {\n            closeNodeButton.onClick.RemoveAllListeners();\n            closeNodeButton.onClick.AddListener(CloseNode);\n        }\n        else Debug.LogWarning(\"[UIPanelRoot] closeNodeButton not bound (expected NodePanel/Panel/CloseBT)\", this);\n    }\n    void AutoWireNewsPanelButtonsIfMissing()\n    {\n        if (closeNewsButton != null) return;\n        if (!newsPanel) return;\n\n        // 尝试用“名字包含 close / x”的规则自动找一个按钮作为关闭\n        var buttons = newsPanel.GetComponentsInChildren<Button>(true);\n        foreach (var b in buttons)\n        {\n            if (!b) continue;\n            var n = b.name;\n            if (n.IndexOf(\"close\", StringComparison.OrdinalIgnoreCase) >= 0 ||\n                n.IndexOf(\"x\", StringComparison.OrdinalIgnoreCase) == 0 ||   // \"X\"\n                string.Equals(n, \"CloseBT\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(n, \"Close\", StringComparison.OrdinalIgnoreCase))\n            {\n                closeNewsButton = b;\n                break;\n            }\n        }\n    }\n\n    void BindNewsPanelButtonsInCode()\n    {\n        if (!closeNewsButton)\n        {\n            Debug.LogWarning(\"[UIPanelRoot] closeNewsButton not bound (NewsPanel close will not work). Drag it in Inspector or rename it to CloseBT.\", this);\n            return;\n        }\n\n        closeNewsButton.onClick.RemoveAllListeners();\n        closeNewsButton.onClick.AddListener(CloseNews);\n    }\n\n    void OnGameStateChanged()\n    {\n        // 如果节点面板开着，刷新它\n        if (!string.IsNullOrEmpty(_currentNodeId) && nodePanel && nodePanel.activeSelf)\n            RefreshNodePanel();\n\n        // 统一“弹事件”的入口：避免 HUD 多次 Refresh 导致重复开\n        TryAutoOpenEvent();\n    }\n\n    void TryAutoOpenEvent()\n    {\n        if (GameController.I == null) return;\n\n        // 有别的 modal 在显示时不自动弹事件（避免抢焦点）\n        if (IsAnyModalOpen())\n            return;\n\n        var list = GameController.I.State.PendingEvents;\n        if (list == null || list.Count == 0) return;\n\n        OpenEventIfAny();\n    }\n\n    bool IsAnyModalOpen()\n    {\n        if (confirmDialog && confirmDialog.gameObject.activeSelf) return true;\n        if (eventPanel && eventPanel.gameObject.activeSelf) return true;\n        if (newsPanel && newsPanel.gameObject.activeSelf) return true;\n        if (nodePanel && nodePanel.activeSelf) return true;\n        return false;\n    }\n\n    private void ResetUI()\n    {\n        if (eventPanel) eventPanel.gameObject.SetActive(false);\n        if (newsPanel) newsPanel.Hide();\n        if (nodePanel) nodePanel.SetActive(false);\n        if (dim) dim.SetActive(false);\n\n        _currentNodeId = null;\n        HideAgentPicker();\n    }\n\n    // ========= 核心：管理 Dim 与顶层面板的 sibling 顺序 =========\n    void SetModalTop(RectTransform topPanel)\n    {\n        if (!dim) return;\n\n        if (topPanel == null || !topPanel.gameObject.activeSelf)\n        {\n            dim.SetActive(false);\n            return;\n        }\n\n        dim.SetActive(true);\n\n        // topPanel 永远最上层\n        topPanel.SetAsLastSibling();\n\n        // dim 永远在 topPanel 下一层，避免盖住 topPanel\n        int topIndex = topPanel.GetSiblingIndex();\n        dim.transform.SetSiblingIndex(Mathf.Max(0, topIndex - 1));\n    }\n\n    RectTransform GetTopModal()\n    {\n        if (confirmDialog && confirmDialog.gameObject.activeSelf) return (RectTransform)confirmDialog.transform;\n        if (eventPanel && eventPanel.gameObject.activeSelf) return (RectTransform)eventPanel.transform;\n        if (newsPanel && newsPanel.gameObject.activeSelf) return (RectTransform)newsPanel.transform;\n        if (nodePanel && nodePanel.activeSelf) return (RectTransform)nodePanel.transform;\n        return null;\n    }\n\n    // ========= Node Panel =========\n    public void OpenNode(string nodeId)\n    {\n        _currentNodeId = nodeId;\n\n        if (nodePanel) nodePanel.SetActive(true);\n        SetModalTop((RectTransform)nodePanel.transform);"
        },
        {
            "id": 5,
            "status": "success",
            "error": "",
            "changed": false,
            "resolved_target": "",
            "data": "using System;\nusing System.Collections.Generic;\n\nnamespace Core\n{\n    public enum NodeStatus { Calm, Investigating, Containing, Secured }\n    public enum EventKind { Investigate, Contain }\n\n    [Serializable]\n    public class AgentState\n    {\n        public string Id;\n        public string Name;\n\n        public int Perception = 5;\n        public int Operation = 5;\n        public int Resistance = 5;\n        public int Power = 5;\n    }\n\n    [Serializable]\n    public class NodeState\n    {\n        public string Id;\n        public string Name;\n\n        // 0..1 百分比坐标：左下(0,0) 右上(1,1)\n        public float X;\n        public float Y;\n\n        public NodeStatus Status = NodeStatus.Calm;\n\n        public bool HasAnomaly = false;\n        public int AnomalyLevel = 0;\n\n        public string AssignedAgentId = null;\n        public float InvestigateProgress = 0f; // 0..1\n        public float ContainProgress = 0f;     // 0..1\n    }\n\n    [Serializable]\n    public class DecisionOption\n    {\n        public string Id;\n        public string Text;\n\n        // \"Perception\" / \"Operation\" / \"Resistance\" / \"Power\"\n        public string CheckAttr;\n        public int Threshold;\n        public float BaseSuccess = 0.5f;\n\n        public int MoneyOnSuccess = 0;\n        public int MoneyOnFail = 0;\n        public int PanicOnSuccess = 0;\n        public int PanicOnFail = 0;\n\n        public float ProgressDeltaOnSuccess = 0.02f;\n        public float ProgressDeltaOnFail = -0.06f;\n    }\n\n    [Serializable]\n    public class PendingEvent\n    {\n        public string Id;\n        public string NodeId;\n        public EventKind Kind;\n\n        public string Title;\n        public string Desc;\n\n        public List<DecisionOption> Options = new();\n    }\n\n    [Serializable]\n    public class GameState\n    {\n        public int Day = 1;\n        public int Money = 1000;\n        public int Panic = 0;\n\n        public List<NodeState> Nodes = new();\n        public List<AgentState> Agents = new();\n\n        public List<PendingEvent> PendingEvents = new();\n        public List<string> News = new();\n    }\n}"
        }
    ]
}