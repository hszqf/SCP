name: Build & Deploy Unity WebGL to Pages

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'UserSettings/**'
      - 'tools/**'
      - '.github/workflows/build-webgl.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          
          AVAILABLE_GB=$(df --output=avail / | tail -1 | awk '{print int($1/1024/1024)}')
          echo "Available disk space: ${AVAILABLE_GB}GB"
          
          # Only clean if less than 30GB available
          if [ "$AVAILABLE_GB" -lt 30 ]; then
            echo "Cleaning up disk space..."
            sudo rm -rf /usr/share/dotnet
            sudo rm -rf /usr/local/lib/android
            sudo rm -rf /opt/ghc
            sudo rm -rf /opt/hostedtoolcache/CodeQL
            sudo docker image prune -a -f || true
            sudo apt-get clean
          else
            echo "Sufficient disk space available, skipping cleanup"
          fi
          
          echo "=== Disk space after cleanup ==="
          df -h /

      - name: Migrate Docker data-root (if needed)
        run: |
          AVAILABLE_GB=$(df --output=avail / | tail -1 | awk '{print int($1/1024/1024)}')
          
          # Only migrate if less than 30GB available
          if [ "$AVAILABLE_GB" -lt 30 ]; then
            echo "Migrating Docker data-root to /mnt..."
            sudo systemctl stop docker
            sudo mkdir -p /mnt/docker-data
            sudo mv /var/lib/docker/* /mnt/docker-data/ || true
            
            sudo tee /etc/docker/daemon.json > /dev/null <<EOF
          {
            "data-root": "/mnt/docker-data"
          }
          EOF
            
            sudo systemctl start docker
            docker info | grep "Docker Root Dir"
          else
            echo "Sufficient disk space available, skipping Docker migration"
          fi

      - name: Restore Library cache
        uses: actions/cache@v3
        with:
          path: |
            Library
            Library/Bee
            Library/il2cpp_cache
          key: Library-${{ hashFiles('Assets/**', 'ProjectSettings/**', 'Packages/manifest.json') }}
          restore-keys: |
            Library-

      - name: Set up Python for table export
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Validate game data
        run: |
          python3 -m pip install openpyxl
          python3 tools/xlsx_to_json.py --validate-only --xlsx "GameData/Local/game_data.xlsx"

      # WebGL uses RemoteGameDataUrl to fetch Published JSON at runtime.
      # No need to export to Assets/StreamingAssets/ - keep repo clean for unity-builder.

      - name: Diagnostic - Check working tree status
        run: |
          echo "=== git status (porcelain) ==="
          git status --porcelain=v1
          echo "=== git diff (name-status) ==="
          git diff --name-status
          echo "=== git diff (stat) ==="
          git diff --stat
          echo "=== modified tracked files ==="
          git ls-files -m || true

      - name: Assert clean working tree before unity-builder
        run: |
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "ERROR: working tree is dirty before unity-builder"
            git status --porcelain=v1
            exit 1
          fi

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL
          buildsPath: build
          buildName: WebGL
          # If Unity generates files during build (e.g., Library changes), uncomment below as emergency fallback:
          # allowDirtyBuild: true
          # However, diagnostic steps above should help identify root cause first.

      - name: Locate WebGL root (folder containing index.html)
        id: webglroot
        run: |
          INDEX_PATH=$(find build -name index.html -type f | head -1)
          if [ -z "$INDEX_PATH" ]; then
            echo "ERROR: index.html not found under build/."
            echo "==== build tree ===="
            find build -type f | head -200
            exit 1
          fi
          ROOT_PATH=$(dirname "$INDEX_PATH")
          echo "WebGL root: $ROOT_PATH"
          echo "path=$ROOT_PATH" >> $GITHUB_OUTPUT

      - name: Prepare Pages staging directory
        run: |
          WEBGL_ROOT="${{ steps.webglroot.outputs.path }}"
          if [ ! -f "$WEBGL_ROOT/index.html" ]; then
            echo "ERROR: index.html not found in WebGL root: $WEBGL_ROOT"
            exit 1
          fi

          # clean staging
          rm -rf public

          # Create public directory
          mkdir -p public

          # Copy contents of WebGL root directly into public/ (preserve Build/ structure)
          cp -R "$WEBGL_ROOT"/. public/

          # Disable Jekyll
          touch public/.nojekyll

          echo "==== Staging directory structure (public) ===="
          ls -lah public
          echo "==== Build subdirectory ===="
          if [ -d "public/Build" ]; then
            ls -lah public/Build
          else
            echo "ERROR: public/Build not found after copy."
            exit 1
          fi

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
