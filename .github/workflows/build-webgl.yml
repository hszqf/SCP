name: Build & Deploy Unity WebGL to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: [self-hosted, Windows]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Validate Unity secrets (no secret values printed)
        shell: powershell
        run: |
          if (-not '${{ secrets.UNITY_LICENSE }}') { throw "Missing secret: UNITY_LICENSE" }
          if (-not '${{ secrets.UNITY_EMAIL }}')   { throw "Missing secret: UNITY_EMAIL" }
          if (-not '${{ secrets.UNITY_PASSWORD }}'){ throw "Missing secret: UNITY_PASSWORD" }
          Write-Host "Unity secrets look present."

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL
          buildsPath: build
          buildName: WebGL

      - name: Locate WebGL root (folder containing index.html)
        id: webglroot
        shell: powershell
        run: |
          $index = Get-ChildItem build -Recurse -Filter index.html | Select-Object -First 1
          if (-not $index) {
            Write-Host "ERROR: index.html not found under build/."
            Write-Host "==== build tree ===="
            Get-ChildItem build -Recurse -Force | Select-Object -First 200 | % FullName
            exit 1
          }
          $root = $index.Directory.FullName
          Write-Host "WebGL root: $root"
          "path=$root" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Prepare Pages staging directory
        shell: powershell
        run: |
          $webglRoot = '${{ steps.webglroot.outputs.path }}'
          if (-not (Test-Path (Join-Path $webglRoot "index.html"))) {
            throw "ERROR: index.html not found in WebGL root: $webglRoot"
          }

          # clean staging
          if (Test-Path "public") { Remove-Item -Recurse -Force "public" }

          New-Item -ItemType Directory -Force -Path "public\SCP" | Out-Null

          # Copy contents of WebGL root into public/SCP (preserve Build/ structure)
          Copy-Item -Recurse -Force -Path (Join-Path $webglRoot "*") -Destination "public\SCP"

          # Disable Jekyll
          New-Item -ItemType File -Force -Path "public\.nojekyll" | Out-Null

          Write-Host "==== Staging directory structure (public\SCP) ===="
          Get-ChildItem -Force "public\SCP" | Format-Table Name,Length,LastWriteTime -AutoSize
          Write-Host "==== Build subdirectory ===="
          if (Test-Path "public\SCP\Build") {
            Get-ChildItem -Force "public\SCP\Build" | Format-Table Name,Length,LastWriteTime -AutoSize
          } else {
            throw "ERROR: public\SCP\Build not found after copy."
          }

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
